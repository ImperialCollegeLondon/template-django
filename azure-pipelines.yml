pool:
  vmImage: "ubuntu-16.04"

variables:
  imageName: "template-django:$(Build.SourceVersion)"

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: 3.7.0
      architecture: "x64"

  - script: |
      pip install -r requirements.txt
      pip install flake8 unittest-xml-reporting
    displayName: "Install prerequisites"

  - script: |
      flake8
    displayName: "Run linter"

  - script: |
      python manage.py test --testrunner xmlrunner.extra.djangotestrunner.XMLTestRunner --no-input
    condition: succeededOrFailed()
    displayName: "Run tests"

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: "**/TEST-*.xml"
      testRunTitle: "Python $(PYTHON_VERSION)"

  - script: |
      docker build -f Dockerfile -t $(dockerId).azurecr.io/$(imageName) .
      docker login -u $(dockerId) -p $pswd $(dockerid).azurecr.io
      docker push $(dockerId).azurecr.io/$(imageName)
    env:
      pswd: $(dockerPassword)
    displayName: "Build and push Docker image"
    enabled: false
